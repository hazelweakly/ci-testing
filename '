name: Test Nightly
on:
  schedule:
    - cron: "* * * * *"

jobs:
  outputs:
    runs-on: ubuntu-latest
    outputs:
      changed: ${{ steps.get-changed.outputs.changed-files }}
      cryptol-version: ${{ steps.cryptol-version.outputs.cryptol-version }}
    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0
      - id: get-changed
        run: echo "::set-output name=changed-files::$(git diff-tree --no-commit-id --name-only -r ${{ github.sha }} | xargs)"

  build:
    needs: [outputs]
    if: ${{ needs.outputs.outputs.changed }}
    runs-on: ubuntu-latest
    name: Nightly
    steps:
      - uses: actions/checkout@v2
        with:
          submodules: true

      - if: ${{ steps.files.outputs.files }}
        run: echo ::set-env name=CRYPTOL_VERSION::"$(cat cryptol.cabal | grep 'Version:' | awk '{print $2}')"

      - name: Publish to Registry
        if: ${{ steps.files.outputs.files }}
        uses: elgohr/Publish-Docker-Github-Action@master
        with:
          name: galoisinc/cryptol
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
          tags: "latest,${{ env.CRYPTOL_VERSION }}"
